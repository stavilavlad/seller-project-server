import express from "express";
import cors from "cors";
import multer from "multer";
import pg from "pg";
import path from "path";
import { fileURLToPath } from "url";
import { dirname, join } from "path";
import bcrypt from "bcrypt";
import session from "express-session";
import passport from "passport";
import LocalStrategy from "passport-local";
import jwt from "jsonwebtoken";
import passportJWT from "passport-jwt";
import dotenv from "dotenv";
dotenv.config();

const JWTStrategy = passportJWT.Strategy;
const ExtractJWT = passportJWT.ExtractJwt;

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const saltRounds = 10;

const app = express();
const db = new pg.Client({
  database: process.env.DB_NAME,
  host: process.env.DB_HOST,
  user: process.env.DB_USER,
  password: process.env.DB_PASSWORD,
  port: process.env.DB_PORT,
});

// MIDDLEWARE
app.use(express.json());
app.use(cors());
app.use("/uploads", express.static(path.join(__dirname, "uploads")));

app.use(
  session({
    secret: "BIGSECRET",
    resave: false,
    saveUninitialized: true,
    cookie: {
      maxAge: 1000 * 60 * 60 * 24,
    },
  })
);

app.use(passport.initialize());
app.use(passport.session());

const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    cb(null, "uploads/");
  },
  filename: (req, file, cb) => {
    const uniqueSuffix = Date.now() + "-" + Math.round(Math.random() * 1e9);
    const extension = path.extname(file.originalname);
    cb(null, `${file.fieldname}-${uniqueSuffix}${extension}`);
  },
});

const upload = multer({ storage: storage });

// connect to db
db.connect();

app.post("/register", async (req, res) => {
  try {
    const { username, password } = req.body;

    const checkUser = await db.query("SELECT * FROM users WHERE username = $1", [username]);

    if (checkUser.rows.length > 0) {
      return res.status(400).send("Username already exists");
    } else {
      bcrypt.hash(password, saltRounds, async (err, hash) => {
        if (err) {
          console.error(err);
          return res.status(500).send("Error hashing password");
        } else {
          try {
            const result = await db.query("INSERT INTO users (username, password) VALUES ($1, $2) RETURNING *", [username, hash]);
            console.log(result.rows[0]);
            res.send("Registered");
          } catch (error) {
            console.error("Registration error:", error);
            res.status(500).send("Registration failed. Please try again.");
          }
        }
      });
    }
  } catch (error) {
    console.error(error);
    res.status(500).send("Internal Server Error");
  }
});

app.post("/login", passport.authenticate("local"), async (req, res) => {
  const user = req.user;
  console.log(req.session);

  res.json({ id: user.id, username: user.username, createdAt: user.registration_date });
});

app.post("/logout", async (req, res) => {
  req.logout(function (err) {
    if (err) {
      return next(err);
    }
    console.log(req.session);

    res.send("loged out");
  });
});

app.get("/products", async (req, res) => {
  try {
    const response = await db.query("SELECT * FROM products ORDER BY id");
    if (req.isAuthenticated()) {
      console.log(req.session);
    } else {
      console.log("not auth");
    }
    res.json({ products: response.rows, count: response.rowCount });
  } catch (error) {}
});

app.get("/products/:id", async (req, res) => {
  try {
    const id = req.params.id;
    const views = await db.query("UPDATE products SET views = (SELECT views FROM products WHERE id = $1) + 1 WHERE id = $2 RETURNING views", [id, id]);
    const response = await db.query("SELECT * FROM products WHERE id = $1", [id]);
    res.json({ product: response.rows[0], views: views.rows[0] });
  } catch (error) {}
});

app.post("/listing", upload.array("file", 4), async (req, res) => {
  try {
    const { title, description, category, used, price, negociable } = req.body;

    const response = await db.query("INSERT INTO products (title, description, category, new, images, price, negociable) VALUES ($1, $2, $3, $4, $5, $6, $7) RETURNING *", [title, description, category, used ? true : false, req.files.map((item) => item.filename), price, negociable ? true : false]);
    res.send("Listing created succesfully");
  } catch (error) {
    console.error("Error while creating listing:", error);
    res.status(500).send("Internal Server Error");
  }
});

passport.use(
  new LocalStrategy(async function verify(username, password, cb) {
    try {
      const result = await db.query("SELECT * FROM users WHERE username = $1", [username]);
      console.log(result.rows);
      if (result.rows.length > 0) {
        const user = result.rows[0];
        bcrypt.compare(password, user.password, (err, result) => {
          if (err) {
            return cb(err);
          } else {
            if (result) {
              return cb(null, user);
            } else {
              return cb(null, false);
            }
          }
        });
      } else {
        return cb("User not found");
      }
    } catch (error) {
      return cb(error);
    }
  })
);

passport.serializeUser((user, cb) => {
  cb(null, user);
});

passport.deserializeUser((user, cb) => {
  cb(null, user);
});

const port = 3000;
app.listen(port, () => {
  console.log(`Server started on port ${port}.`);
});
